<!-- PAGE_TITLE: Messages | Tramway Drifting and Dungeon Exploration Simulator Software Development Kit -->

<h1>
	Messages
</h1>

<hr/>

<p>
	Messages are the main way <a href="entity.html">entities</a> communicate
	amongst themselves.
</p>

<p>
	They allow for greater decoupling. Entities don't have to know about each
	other's capabilites or any other characteristics, they only need to know
	about the types of messages.
</p>

<p>
	To allow effective communication between enities, we only need to define
	what a certain message type means. For this purpose the framework includes
	many different and useful message types with predefined meanings.
</p>

<center>
	<img src="message.gif"/><br/>
	<i>Potato cat is sending potato frog a Message.</i>
</center>

<h2>
	Message types
</h2>

<hr/>

<h4>
	None | <code>NONE</code>
</h4>

<p>
	Dummy message type, doesn't mean anything.
</p>

<h4>
	Ping | <code>PING</code>
</h4>

<p>
	Generic message type. Can be used to probe entities. When pinged, certain
	entities will emit an event, or print text to console.
</p>

<h4>
	Move pick up | <code>MOVE_PICK_UP</code>
</h4>

<p>
	Was used to create crate stacking mechanics for immersive sims. Not used
	anymore, since I added better techniques for the coordination of crate
	stacking.
</p>

<h4>
	Open | <code>OPEN</code>
</h4>

<p>
	Used to tell doors and similar entities to open.
</p>

<h4>
	Open | <code>OPEN</code>
</h4>

<p>
	Used to tell doors and similar entities to open. More generally, could be
	used for entities with two distinct states to assume the non-default state.
</p>

<h4>
	Close | <code>CLOSE</code>
</h4>

<p>
	Used to tell doors and similar entities to close. More generally, could be
	used for entities with two distinct states to assume the default state.
</p>

<h4>
	Lock | <code>LOCK</code>
</h4>

<p>
	Used to tell doors and other entities with some kind of opening and closing
	mechanism to stop opening. More generically could be used to tell enitities
	to ignore certain inputs, such as the activation messages.
</p>

<h4>
	Unlock | <code>UNLOCK</code>
</h4>

<p>
	Similar to locking message, but in reverse.
</p>

<h4>
	Toggle | <code>TOGGLE</code>
</h4>

<p>
	Similar to open and close messages. Used to tell entities to toggle their
	state, that is, if closed, to open, or if open, to close.
</p>

<h4>
	Kill | <code>KILL</code>
</h4>

<p>
	Used to tell entities to yeet themselves.
</p>

<h4>
	Trigger | <code>TRIGGER</code>
</h4>

<p>
	Used to pass an arbitrary message to an entity. The message data field will
	then contain a pointer to a <a href="value.html">Value</a>, usually with 
	the type of <a href="uid.html">name</a>.
</p>

<p>
	For example, <a href="../extensions/kitchensink.html">Quests</a> from the
	kitchensink extension will create a quest entity, so that they can receive
	messages from <a href="signal.html">Signals</a>. Since quests have triggers,
	this message is used to trigger them.
</p>

<h4>
	Start | <code>START</code>
</h4>

<p>
	Similar to open message, but used for entities that have some kind of
	continuos action. For example, the
	<a href="../enitities/sound.html">Sound</a> entity uses this message to
	begin playback of its associated sound.
</p>

<h4>
	Stop | <code>STOP</code>
</h4>

<p>
	This type is the counterpart to the start message. It tells entities to
	stop their action. For example, the
	<a href="../enitities/decoration.html">Decoration</a> entity uses this 
	message to stop playing its animation, if it has one.
</p>

<h4>
	Activate | <code>ACTIVATE</code>
</h4>

<p>
	Sent every <a href="core.html">tick</a> from an agentic entity. Generally 
	meant to be used when a player presses the keyboard key associated with the 
	<a href="ui.html">Use</a> keyboard action while facing an entity.
</p>

<h4>
	Activate Once | <code>ACTIVATE_ONCE</code>
</h4>

<p>
	Similar to Activate message, but meant to be sent only for the first tick of
	the activation.
</p>

<h4>
	Select | <code>SELECT</code>
</h4>

<p>
	Used to tell an entity that it is being selected. This could be when a
	player is facing in the direction of the entity, or when the player has
	placed the mouse cursor over said entity.
</p>

<p>
	In response, most entities will emit a <a href="event.html">Selected</a>
	event.
</p>

<h4>
	Set Progress | <code>SET_PROGRESS</code>
</h4>

<p>
	Used to set the progress of the action that the entity is performing. The
	data pointer of the message should be set to a Value. Usually it will be a
	<a href="type.html">Float32</a> value in the range from 0.0f to 1.0f. 
</p>

<p>
	For example, the 
	<a href="../extensions/kitchensink/button.html">Button</a> entity will use
	it to set its opening/closing state. A value of 0.0 will close it
	completely, a value of 1.0 will open it completely and a value of 0.5 will
	set it to being half-open.
</p>

<h4>
	Set Animation | <code>SET_ANIMATION</code>
</h4>

<p>
	Used to set the animation of an entity. The data pointer will then be set
	to a Value with the type of name. The name will be the name of the 
	animation to which this entity should switch.
</p>

<h4>
	Last Mesasge | <code>LAST_MESSAGE</code>
</h4>

<p>
	Not actually a message type.
</p>

<h2>
	Programming in C++
</h2>

<hr/>

<p>
	<code>#<span class="codekeyw">include</span> &lt;<span class="codelit">framework/message.h</span>&gt;</code> <br/>
	<a href="../../cppapi/structtram_1_1_message.html">API documentation
	page</a>.
</p>

<p>
	The API for message sending is nearly identical to that of the 
	<a href="event.html">Event</a>.
</p>

<code>
	<span class="codeclass">Message</span> msg;<br/>
	<br/>
	msg.type = <span class="codeclass">Message</span>::PING;<br/>
	msg.sender = <span class="codekeyw">this</span>-><span class="codefunc">GetID</span>();<br/>
	msg.receiver = <span class="codeclass">Entity</span>::<span class="codefunc">Find</span>(<span class="codelit">"mongus"</span>)-><span class="codefunc">GetID</span>();<br/>
	msg.data = <span class="codeclass">Message</span>::<span class="codefunc">AllocateData</span>&lt;<span class="codeclass">Value</span>&gt;(<span class="codelit">420</span>);<br/>
	<br/>
	<span class="codecomm">// this will ping mongus</span><br/>
	<span class="codeclass">Message</span>::<span class="codefunc">Send</span>(msg);<br/>
	<br/>
	<span class="codecomm">// we can also delay the message, pinging</span><br/>
	<span class="codecomm">// mongus 69 seconds in the future</span><br/>
	msg.data = <span class="codekeyw">nullptr</span>;<br/>
	<span class="codeclass">Message</span>::<span class="codefunc">Send</span>(msg, <span class="codelit">69.0f</span>);
</code>

<p>
	The <code>Message::AllocateData()</code> static method will allocate memory
	for the message's data. This memory will get automatically released after
	all of the messages get dispatched.
</p>

<p>
	Unfortunately, due to certain limitations, this allocation works only for
	messages that get sent without a delay. This will be remedied in the future.
</p>

<p>
	Just like with events, we can register our own message types.
</p>

<code>
	<span class="codekeyw">message_t</span> type = <span class="codeclass">Message</span>::<span class="codefunc">Register</span>(<span class="codelit">"frog-message"</span>);<br/>
	<br/>
</code>

<h2>
	Scripting in Lua
</h2>

<hr/>

<p>
	Essentially the same as in C++.
</p>

<code>
	msg = {}<br/>
	<br/>
	msg.type = tram.message.PING<br/>
	msg.sender = <span class="codelit">0</span><br/>
	msg.receiver = tram.entity.<span class="codefunc">Find</span>(<span class="codelit">"mongus"</span>):<span class="codefunc">GetID</span>()<br/>
	msg.data = <span class="codelit">420</span><br/>
	<br/>
	tram.message.<span class="codefunc">Send</span>(msg, <span class="codelit">69.0</span>)
</code>
